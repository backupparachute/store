<script type="text/javascript">

  function addProductCard(name, descrip, price, image_url, id){
    price = parseFloat(price);
    var card = $([
      "<div class='card'>",
      "  <div class='card-image'>",
      "    <img src='"+ image_url + "' alt=''>",
      "  </div>",
      "  <div class='card-header'>",
      "    " + name,
      "  </div>",
      "  <div class='card-copy'>",
      "    <p>"+descrip+"</p>",
      "    <p>$"+price.toFixed(2)+"</p>",
      "    <button class='add-to-cart' data-product-id="+id+">Add to Cart</button>",
      "    <button class='buy-now' data-product-id="+id+">Buy Now</button>",
      "  </div>",
      "</div>"
    ].join("\n"));
    card.appendTo('.cards');
  }

  function buildHeaders()
  {
    var headers;
    if(localStorage.getItem('cartToken').length)
    {
      headers = { 'Accept-Version': 'v1', 'Cart-Token': localStorage.getItem('cartToken') };
    }
    else
    {
      headers = { 'Accept-Version': 'v1'}; 
    }
    return headers;
  }

  function updateCartTotals(items)
  {
    var totalQty = 0;
    var totalPrice = 0.0;
    items.forEach(function (item) {
      totalQty += item['quantity'];
      totalPrice += item['price'] * item['quantity'];
    }); 
    $('#cartQty').html('Items: '+totalQty);
    $('#cartTotal').html('$'+totalPrice);
  }

  $(document).ready(function() {
    
    // Add to Cart
    $(document).on('click', '.add-to-cart', function() {
      productId = $(this).data('product-id');
      $.ajax({
        url: 'http://bps.paywithcanopy.com/api/cart/add_item/'+productId+'.json', 
        headers: buildHeaders(),
      })
       .done(function( data ) {
         updateCartTotals(data['shopping_cart']['shopping_cart_items']);
         localStorage.setItem('cartToken', data['shopping_cart']['token']);
       });
    });

    // Buy Now 
    $(document).on('click', '.buy-now', function() {
      productId = $(this).data('product-id');
      $.ajax({
        url: 'http://bps.paywithcanopy.com/api/cart/add_item/'+productId+'.json', 
        headers: buildHeaders(),
      })
       .done(function( data ) {
         $(location).attr('href','http://bps.paywithcanopy.com/checkout?cart_token='+data['shopping_cart']['token']);
         //$(location).attr('href','http://bps.paywithcanopy.com/invoices/'+data['token']+'/pay');
       });
    }); 

    // Checkout
    $(document).on('click', '.checkout-btn', function() {
      $.ajax({
        url: 'http://bps.paywithcanopy.com/api/cart.json', 
        headers: buildHeaders(),
      })
       .done(function( data ) {
        $(location).attr('href','http://bps.paywithcanopy.com/checkout?cart_token='+data['shopping_cart']['token']);
       });
    });

    // Retrieve all products
    if ($('.cards').length){
      $.ajax({
        url: 'http://bps.paywithcanopy.com/api/products.json', 
        headers: { 'Accept-Version': 'v1' }, 
      })
       .done(function( data ) {
         data['products'].forEach(function (product) {
           addProductCard(product["name"], product["description"], product["price"], product["image_url"], product["id"]);
         }); 
       });
    }

    // Retrieve current cart
    if ($('.checkout-btn').length){
      $.ajax({
        url: 'http://bps.paywithcanopy.com/api/cart.json', 
        headers: buildHeaders(),
      })
       .done(function( data ) {
         updateCartTotals(data['shopping_cart']['shopping_cart_items']);
       });
    }
    
  });
</script>
